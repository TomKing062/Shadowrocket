name: Shadowrocket
on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: "0 22 * * 0"
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: run
        run: |
          mkdir master
          echo "COMMIT_INFO=Uploaded on $(TZ='Asia/Shanghai' date +%Y%m%d%H%M)" >> $GITHUB_ENV
          curl -o Head.conf https://raw.githubusercontent.com/dler-io/Rules/main/Surge/Surge%204/Head.conf
          curl -o Rule.conf https://raw.githubusercontent.com/TomKing062/Shadowrocket/main/Rule.conf
          curl -o MITM.conf https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Shadowrocket/Advertising/Advertising_MITM.sgmodule
          cat Head.conf Rule.conf MITM.conf>master/Surge.conf
          cd master
          curl -o StreamingSE.list https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Ruleset/StreamingMedia/StreamingSE.list
          grep bili StreamingSE.list>Streaming.list
          
          sed -i "/\[Rule\]/i\[Proxy Group\]" Surge.conf
          sed -i "/\[Rule\]/i\EmbyServer \= select\,policy\-regex\-filter\=\(free\)" Surge.conf
          sed -i "/\[Rule\]/i\港台节点 \= select\,policy\-regex\-filter\=\(港\|台\)" Surge.conf
          sed -i "/\[Rule\]/i\Streaming \= select\,DIRECT\,港台节点\,PROXY" Surge.conf
          sed -i "/RULE\-SET\,SYSTEM\,DIRECT/a\RULE\-SET\,https\:\/\/raw\.githubusercontent\.com\/TomKing062\/Shadowrocket\/master\/Streaming\.list\,Streaming" Surge.conf
          sed -i "/RULE\-SET\,SYSTEM\,DIRECT/a\DOMAIN\-KEYWORD\,emby\,EmbyServer" Surge.conf
          
          curl -o Complete.conf https://raw.githubusercontent.com/dler-io/Rules/main/Shadowrocket/Complete.conf
          sed -i "/\[Rule\]/i\[Proxy Group\]" Complete.conf
          sed -i "/\[Rule\]/i\EmbyServer \= select\,policy\-regex\-filter\=\(free\)" Complete.conf
          sed -i "/\[Rule\]/i\港台节点 \= select\,policy\-regex\-filter\=\(港\|台\)" Complete.conf
          sed -i "/\[Rule\]/i\Streaming \= select\,DIRECT\,港台节点\,PROXY" Complete.conf
          sed -i "/\[Rule\]/a\RULE\-SET\,https\:\/\/raw\.githubusercontent\.com\/Loyalsoldier\/surge-rules\/release\/ruleset\/apple\.txt\,DIRECT" Complete.conf
          sed -i "/\[Rule\]/a\RULE\-SET\,https\:\/\/raw\.githubusercontent\.com\/TomKing062\/Shadowrocket\/master\/Streaming\.list\,Streaming" Complete.conf
          sed -i "/\[Rule\]/a\DOMAIN\-KEYWORD\,emby\,EmbyServer" Complete.conf

      - name: push
        run: |
          cd master
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git init
          git checkout -b master
          git add .
          git commit -m "${{ env.COMMIT_INFO }}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u origin master
