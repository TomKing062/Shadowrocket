name: Shadowrocket
on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 4"
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0
          delete_workflow_pattern: run

      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: master
          path: master

      - name: Run
        run: |
          rm master/*
          curl -o cn.txt https://raw.githubusercontent.com/Loyalsoldier/geoip/release/text/cn.txt
          cat cn.txt | perl -ne '/^(\d{1,3}(\.\d{1,3}){3}\/\d{1,2})/ && print "IP-CIDR,$1,no-resolve\n"' > master/cncidr.txt
          cat cn.txt | grep ":" | perl -ne '/(.+\/\d+)/ && print "IP-CIDR,$1,no-resolve\n"' >> master/cncidr.txt
          curl -o StreamingSE.list https://raw.githubusercontent.com/DivineEngine/Profiles/master/Surge/Ruleset/StreamingMedia/StreamingSE.list
          grep bili StreamingSE.list > master/Streaming.list
          curl -o Head.conf https://raw.githubusercontent.com/dler-io/Rules/main/Surge/Surge%204/Head.conf
          curl -o Rule.conf https://raw.githubusercontent.com/TomKing062/Shadowrocket/main/Rule.conf
          curl -o MITM.conf https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Shadowrocket/Advertising/Advertising_MITM.sgmodule
          cat Head.conf Rule.conf MITM.conf > master/Shadowrocket.conf
          sed -i "/test/d" master/Shadowrocket.conf
          sed -i "/#/d" master/Shadowrocket.conf
          
          curl -o Rule-edu.conf https://raw.githubusercontent.com/TomKing062/Shadowrocket/main/Rule-edu.conf
          cat Head.conf Rule-edu.conf > master/Edu.conf
          sed -i "/test/d" master/Edu.conf
          sed -i "/#/d" master/Edu.conf

      - name: push
        run: |
          cd master
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Uploaded on $(TZ='Asia/Shanghai' date +%Y%m%d%H%M)"
          git push
